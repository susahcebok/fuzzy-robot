<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://www.twibbon.udb.ac.id/css/croppie.css">
<link rel="stylesheet" href="https://www.twibbon.udb.ac.id/css/app.css"> 
<script src="https://kit.fontawesome.com/c2b9b7aca3.js"></script> 

<title>udbmoving - UDB Twibbon Generator</title>

</head>
<body>

<div class="container-fluid">
<div class="row justify-content-center">
<div class="col-md-4 text-center mb-4"> 
<img src="images/logo.png" width="120"/>
<hr/>
<div class="uploader"> 
<canvas id="imageCanvas" class="image-canvas"></canvas>
<div class="download-button"> 
<input type="file" name="file" id="imageLoader" class="inputfile" accept="image/*" /> 
<label for="imageLoader">Pilih Foto</label>
<a class="button" id="basic-result">Preview</a>
<a id="downloadlink">Unduh</a>
</div>
<div class="profile-pic-wrap">
<div id="demo-basic"></div> 
<a class="button bg-secondary" id="putar">Putar Foto</a>
</div> 
<!--<a id="downloadlink"></a>-->
</div>
<div class="card-body">
<h5 class="card-title text-center">Panduan Penggunaan Twibbon</h5>
<ol type="numbered" style="padding-left:20px; text-align:justify;">
<li>Klik Tombol <label for="imageLoader">Pilih Foto</label>. Pilih foto yang kamu inginkan</li>
<li>Kamu bisa melakukan zoom, geser atau putar foto</li>
<li>Jika sudah sesuai, klik tombol <b>Preview</b></li>
<li>Silahkan <b>Download</b> atau <b>Share</b> ke sosial media kamu</li>
<li>Selesai</li>
</ol>
</div>
</div>
</div>
</div> 

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script> 
<script src="https://www.twibbon.udb.ac.id/js/load-image.all.min.js"></script>
<style type="text/css">
	.cr-boundary:before{content:'';position:absolute;top:0;left:0;height:100%;width:100%;background-image:url(badut.png);background-size:100%}
</style>
<script type="text/javascript">var kampanye = '1_twibbon_udb.png'; var judul = 'udbmoving';</script>
<!--<script src="js/app.js"></script> -->

<script>
var imageLoader = document.getElementById('imageLoader');
    imageLoader.addEventListener('change', handleImage, false);
var canvas = document.getElementById('imageCanvas');
    canvas.width = 1000;
    canvas.height = 1000;
var ctx = canvas.getContext('2d');

/**
function popupResult(result) {
  var html;

  if (result.html) {
  	html = result.html;
  }

  if (result.src) {
  	html = '<img src="' + result.src + '" />'
  }

  Swal.fire({
    html:html
  });

  Swal.fire({
    title: 'Share ke sosial media kamu',
    html:html,
    showDenyButton: true,
    showCancelButton: true,
    confirmButtonText: `Share`,
    denyButtonText: `Download`,
  }).then((result) => {
    /* Read more about isConfirmed, isDenied below */
    if (result.isConfirmed) {
      shareImage();
      return false;
    } else if (result.isDenied) {
      downloadImage();
    }
  })

}
**/

/**
 * Draw image
 */
function drawFrame() {
  var img = new Image();
  img.crossOrigin = "Anonymous";
  img.src = 'images/'+kampanye;  
  img.onload = function() {
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    popupResult({
			src: document.getElementById('imageCanvas').toDataURL('image/jpg'),
		});
	   console.log('popup ok');
  }
}


function drawProfPict(src) {
  var img = new Image();
  img.onload = function(){
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    drawFrame();
  }

  img.src = src;
}

/**
 * Load image from user
 */
function handleImage(e) {
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  var img_url = e.target.files[0];
  loadImage.parseMetaData(img_url, function(data) {
    var ori = 0;
    if (data.exif) {
      ori = data.exif.get('Orientation');
    }

    var loadingImage = loadImage(
      img_url,
      function(canvas) {
        $('.cr-slider').css('visibility', 'visible');
        $('.loader').remove();

        var dataUrl = canvas.toDataURL('image/jpeg');
        basic.croppie('bind', {
            url: dataUrl
        });
      },
      {
        maxWidth: 2800,
        maxHeight: 2800,
        orientation: ori,
        canvas: true
      });

    loadingImage.onloadstart = function(event) {
      $('.cr-viewport').append('<div class="loader"></div>');
    }
  });
}


/**
 * Download image from canvas
 */

function downloadCanvas(link, canvasId, filename) {
  link.href = document.getElementById(canvasId).toDataURL('image/jpeg');
  link.download = filename;
}

/*
$('#unduh').on('click', '.sweet-alert', function() {
  downloadCanvas(this, 'imageCanvas', 'udb-twibbon');
});
*/

function downloadImage() {
  var link = document.getElementById("downloadlink");
  link.href = document.getElementById("imageCanvas").toDataURL();
  link.download = "udb_twibbon.png";
  link.click();
}


//share
function shareImage() {
  var gambar = document.getElementById("imageCanvas");
  gambar.toBlob( async function(blob) {

    var file = new File([blob], "udb_twibbon.png", {type: 'image/png'});

    const shareData = {
      title: 'Share UDB Twibbon',
      text: '#'+judul+' | UDB The Global Entrepreneur University',
      url: 'https://twibbon.udb.ac.id?udb='+judul,
      files: [file]
    };

    if (navigator.share) {
        await navigator.share(shareData).then(() => {
          console.log("Berhasil sharing");
        })
        .catch(err => {
          console.log(err.message);
        });
    } else {
        Swal.fire("Browser tidak support share");
    }

  });
};

var basic = $('#demo-basic').croppie({
    viewport: {
        width: Math.min(300, window.innerWidth - 50),
        height: Math.min(300, window.innerWidth - 50)
    },
    boundary: {
      width: Math.min(300, window.innerWidth - 50),
      height: Math.min(300, window.innerWidth - 50),
    },
    enableOrientation: true,
    enableResize: true,
    enforceBoundary:false
});


$('#basic-result').on('click', function(e) {
  e.preventDefault();
  console.log('OK');
  var downloadButton = this;
  basic.croppie('result', {
		type: 'canvas',
    size:'original',
	}).then(function (resp) {
		drawProfPict(resp);
	});
});

//putar
$('#putar').click(function() {
  basic.croppie('rotate', -90);
});
</script>
</body>
</html>
